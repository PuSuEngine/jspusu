<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script type="text/javascript" src="../dist/pusu.js"></script>
</head>
<body>
<section>
    <form>
        <label for="message">Message:</label> <input type="text" id="message"/>
        <button type="submit">Send</button>
        <div>Messages received <span class="counter">0</span>.</div>
        <div class="messages"></div>
    </form>
</section>

<script type="text/javascript">
    var SERVER = "ws://127.0.0.1:55000";
    var CHANNEL = "channel.1";

    var count = 0;
    var messages = document.querySelector(".messages");
    var counter = document.querySelector(".counter");

    var messageContent = "";

    var client = new PuSu(SERVER);
    var connect = client.connect();
    console.log(connect);
    connect.promise.then(function () {
        var authorize = client.authorize("foo");
        console.log(authorize);
        authorize.promise.then(function () {
            var subscribe = client.subscribe(CHANNEL, function(msg) {
                messageContent = msg + "\n" + messageContent;
                messageContent = messageContent.substring(0, 2048);
                count += 1;
            });
        });
    });

    var field = document.querySelector("#message");
    function onSubmit(event) {
        var content = field.value;
        field.value = "";
        client.publish(CHANNEL, content);
        event.preventDefault();
    }

    document.querySelector("form").addEventListener("submit", onSubmit);

    setInterval(function() {
        messages.innerText = messages.textContent = messageContent;
        counter.innerText = counter.textContent = count;
    }, 25);
</script>
</body>
</html>